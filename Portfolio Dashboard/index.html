<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Portfolio Risk Analytics Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>
/* (same styling as you shared; trimmed for brevity) */
*{margin:0;padding:0;box-sizing:border-box} body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0a0e27;color:#fff;min-height:100vh}
.dashboard{padding:20px;max-width:1600px;margin:0 auto} .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:20px;padding:40px;margin-bottom:30px;box-shadow:0 20px 40px rgba(0,0,0,0.4);text-align:center}
h1{font-size:36px;margin-bottom:10px;text-shadow:2px 2px 4px rgba(0,0,0,0.3)} .subtitle{opacity:.9;font-size:18px}
.controls{display:flex;gap:15px;justify-content:center;margin-top:25px;flex-wrap:wrap}
.btn{background:rgba(255,255,255,0.2);border:2px solid rgba(255,255,255,0.3);color:#fff;padding:12px 25px;border-radius:10px;cursor:pointer;font-size:16px;font-weight:600;transition:all .3s;backdrop-filter:blur(10px)}
.btn:hover{background:rgba(255,255,255,0.3);transform:translateY(-2px);box-shadow:0 5px 15px rgba(255,255,255,0.2)} .btn.primary{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);border:none}
.tabs{display:flex;gap:10px;margin-bottom:30px;background:rgba(255,255,255,0.05);padding:10px;border-radius:15px;flex-wrap:wrap}
.tab{padding:12px 25px;background:rgba(255,255,255,0.1);border-radius:10px;cursor:pointer;transition:all .3s;font-weight:500}
.tab:hover{background:rgba(255,255,255,0.15)} .tab.active{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;box-shadow:0 5px 15px rgba(102,126,234,0.4)}
.tab-content{display:none;animation:fadeIn .5s} .tab-content.active{display:block} @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.metrics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:30px}
.metric-card{background:linear-gradient(135deg,rgba(255,255,255,0.1),rgba(255,255,255,0.05));border:1px solid rgba(255,255,255,0.1);border-radius:15px;padding:25px;backdrop-filter:blur(10px);transition:transform .3s,box-shadow .3s}
.metric-card:hover{transform:translateY(-5px);box-shadow:0 10px 30px rgba(102,126,234,0.3)}
.metric-label{font-size:12px;color:rgba(255,255,255,0.7);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px}
.metric-value{font-size:32px;font-weight:bold;background:linear-gradient(135deg,#667eea,#f093fb);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.metric-change{font-size:14px;margin-top:5px;opacity:.8} .positive{color:#4ade80}.negative{color:#f87171}
.chart-container{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:15px;padding:25px;margin-bottom:20px;backdrop-filter:blur(10px)}
.chart-title{font-size:20px;margin-bottom:20px;color:#fff}
table{width:100%;background:rgba(255,255,255,0.05);border-radius:15px;overflow:hidden;backdrop-filter:blur(10px)}
th{background:rgba(102,126,234,0.3);padding:15px;text-align:left;font-weight:600;text-transform:uppercase;font-size:12px;letter-spacing:1px}
td{padding:15px;border-bottom:1px solid rgba(255,255,255,0.05)} tr:hover{background:rgba(255,255,255,0.05)}
.upload-area{background:rgba(255,255,255,0.05);border:2px dashed rgba(102,126,234,0.5);border-radius:15px;padding:40px;text-align:center;margin:20px 0;cursor:pointer;transition:all .3s;position:relative}
.upload-area:hover,.upload-area.dragover{background:rgba(102,126,234,0.1);border-color:#667eea}
.upload-area input[type="file"]{position:absolute;width:100%;height:100%;top:0;left:0;opacity:0;cursor:pointer}
.file-info{margin-top:15px;padding:10px;background:rgba(102,126,234,0.2);border-radius:8px;display:none}.file-info.active{display:block}
.grid-2{display:grid;grid-template-columns:repeat(auto-fit,minmax(500px,1fr));gap:20px}
.centered-chart{display:flex;flex-direction:column;align-items:center}
.vertical-stack{display:flex;flex-direction:column;gap:20px}
</style>
</head>
<body>
<div class="dashboard">
  <div class="header">
    <h1>Portfolio Risk Analytics Dashboard</h1>
    <p class="subtitle">Advanced Risk Management & Optimization Platform</p>
    <div class="controls">
      <button class="btn primary" onclick="processCSV()">Compute</button>
      <button class="btn" onclick="showUploadDialog()">Upload CSV</button>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('overview', this)">Overview</div>
    <div class="tab" onclick="switchTab('positions', this)">Positions</div>
    <div class="tab" onclick="switchTab('risk', this)">Risk Metrics</div>
    <div class="tab" onclick="switchTab('factors', this)">Factor Exposure</div>
    <div class="tab" onclick="switchTab('upload', this)">Data Upload</div>
  </div>

  <!-- Overview -->
  <div id="overview" class="tab-content active">
    <div class="metrics-grid">
      <div class="metric-card"><div class="metric-label">Portfolio Value</div><div class="metric-value" id="portfolioValue">$0</div><div class="metric-change" id="portfolioChange">â€”</div></div>
      <div class="metric-card"><div class="metric-label">Total Allocation</div><div class="metric-value" id="totalAllocation">0%</div><div class="metric-change">Capital Deployed</div></div>
      <div class="metric-card"><div class="metric-label">Active Positions</div><div class="metric-value" id="activePositions">0</div><div class="metric-change" id="longShortSplit">Long/Short Split</div></div>
      <div class="metric-card"><div class="metric-label">Portfolio Beta</div><div class="metric-value" id="beta">0.00</div><div class="metric-change">vs Market</div></div>
    </div>

    <div class="grid-2 vertical-stack">
      <div class="chart-container centered-chart">
        <h3 class="chart-title">Sector Allocation</h3>
        <canvas id="sectorChart" width="600" height="240"></canvas>
      </div>
      <div class="chart-container centered-chart">
        <h3 class="chart-title">Capital Allocation by Position</h3>
        <canvas id="allocationChart" width="600" height="240"></canvas>
      </div>
    </div>
  </div>

  <!-- Positions -->
  <div id="positions" class="tab-content">
    <div class="chart-container">
      <h3 class="chart-title">Current Positions</h3>
      <table id="positionsTable">
        <thead>
          <tr>
            <th>Symbol</th><th>Direction</th><th>Sector</th><th>Market Cap</th>
            <th>Price</th><th>Volume</th><th>Allocation (%)</th><th>Timeframe</th>
            <th>Target</th><th>Stop Loss</th><th>Risk/Reward</th>
          </tr>
        </thead>
        <tbody id="positionsBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Risk -->
  <div id="risk" class="tab-content">
    <div class="chart-container">
      <h3 class="chart-title">Portfolio Risk Analytics</h3>
      <div class="metrics-grid">
        <div class="metric-card"><div class="metric-label">Portfolio Beta</div><div class="metric-value" id="portfolioBeta">-</div></div>
        <div class="metric-card"><div class="metric-label">Expected Daily Volatility</div><div class="metric-value" id="dailyVol">-</div></div>
        <div class="metric-card"><div class="metric-label">Weekly Volatility</div><div class="metric-value" id="weeklyVol">-</div></div>
        <div class="metric-card"><div class="metric-label">Expected Daily Range</div><div class="metric-value" id="dailyRange">-</div></div>
        <div class="metric-card"><div class="metric-label">Expected Weekly Range</div><div class="metric-value" id="weeklyRange">-</div></div>
        <div class="metric-card"><div class="metric-label">Max Expected Drawdown</div><div class="metric-value" id="maxDD">-</div></div>
      </div>
    </div>

    <div class="chart-container">
      <h3 class="chart-title">Value at Risk Analysis</h3>
      <div class="metrics-grid">
        <div class="metric-card"><div class="metric-label">Portfolio 5% VaR</div><div class="metric-value" id="var5">-</div></div>
        <div class="metric-card"><div class="metric-label">Portfolio 5% CVaR</div><div class="metric-value" id="cvar5">-</div></div>
        <div class="metric-card"><div class="metric-label">Portfolio 1% VaR</div><div class="metric-value" id="var1">-</div></div>
        <div class="metric-card"><div class="metric-label">Portfolio 1% CVaR</div><div class="metric-value" id="cvar1">-</div></div>
        <div class="metric-card"><div class="metric-label">Tail Risk (0.03%)</div><div class="metric-value" id="tailRisk">-</div></div>
        <div class="metric-card"><div class="metric-label">Tail Risk Multiple</div><div class="metric-value" id="tailMultiple">-</div></div>
      </div>
    </div>

    <div class="chart-container">
      <h3 class="chart-title">Risk Distribution (illustrative)</h3>
      <canvas id="riskChart"></canvas>
    </div>
  </div>

  <!-- Factors -->
  <div id="factors" class="tab-content">
    <div class="chart-container">
      <h3 class="chart-title">Carhart Four-Factor Model</h3>
      <table id="factorTable">
        <thead><tr><th>Factor</th><th>Beta</th><th>T-Statistic</th><th>P-Value</th><th>Significance</th></tr></thead>
        <tbody>
          <tr><td>Market (Mkt-RF)</td><td id="mktBeta">-</td><td id="mktTstat">-</td><td id="mktPval">-</td><td id="mktSig">-</td></tr>
          <tr><td>Size (SMB)</td><td id="smbBeta">-</td><td id="smbTstat">-</td><td id="smbPval">-</td><td id="smbSig">-</td></tr>
          <tr><td>Value (HML)</td><td id="hmlBeta">-</td><td id="hmlTstat">-</td><td id="hmlPval">-</td><td id="hmlSig">-</td></tr>
          <tr><td>Momentum (Mom)</td><td id="momBeta">-</td><td id="momTstat">-</td><td id="momPval">-</td><td id="momSig">-</td></tr>
        </tbody>
      </table>
    </div>

    <div class="chart-container" style="margin-top:20px;">
      <h3 class="chart-title">Factor Exposure Visualization</h3>
      <canvas id="factorChart"></canvas>
    </div>
  </div>

  <!-- Upload -->
  <div id="upload" class="tab-content">
    <div class="chart-container">
      <h3 class="chart-title">Upload Inputs</h3>
      <p style="opacity:.8;margin-bottom:10px;">Provide the three inputs used by your script:</p>
      <ol style="opacity:.8;margin-left:20px;margin-bottom:10px;">
        <li><b>Portfolio CSV</b> (same columns you use)</li>
        <li><b>F-F Research Data Factors (daily) CSV</b> â€” the file with <code>YYYYMMDD</code> date column</li>
        <li><b>F-F Momentum Factor (daily) .txt</b> â€” space-delimited two-column file</li>
      </ol>

      <div class="upload-area">
        <input type="file" id="filePortfolio" accept=".csv,text/csv" />
        <div><p style="font-size:18px;margin-bottom:6px;">Portfolio CSV</p><p style="opacity:.7;">Drop file or click</p></div>
      </div>
      <div class="upload-area">
        <input type="file" id="fileFF3" accept=".csv,text/csv" />
        <div><p style="font-size:18px;margin-bottom:6px;">F-F Factors CSV</p><p style="opacity:.7;">Drop file or click</p></div>
      </div>
      <div class="upload-area">
        <input type="file" id="fileMOM" accept=".txt,text/plain" />
        <div><p style="font-size:18px;margin-bottom:6px;">Momentum TXT</p><p style="opacity:.7;">Drop file or click</p></div>
      </div>

      <div style="margin-top:15px;">
        <label>Date Needed (YYYY-MM-DD, optional): <input id="dateNeeded" style="margin-left:8px;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.1);color:#fff;"></label>
      </div>

      <div style="margin-top:20px;">
        <button class="btn primary" onclick="processCSV()">Compute All Metrics</button>
      </div>
    </div>
  </div>
</div>

<script>
const API_BASE = 'http://localhost:8000';
let charts = {};
let portfolioData = [];
let portfolioCSV = '', ff3CSV = '', momTXT = '';

function switchTab(tab, el) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById(tab).classList.add('active');
}
function showUploadDialog() { switchTab('upload', document.querySelectorAll('.tab')[4]); }

function readFileAsText(file) {
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror = reject;
    r.readAsText(file);
  });
}

async function processCSV() {
  try {
    // load files if chosen
    const f1 = document.getElementById('filePortfolio').files[0];
    const f2 = document.getElementById('fileFF3').files[0];
    const f3 = document.getElementById('fileMOM').files[0];

    if (f1) portfolioCSV = await readFileAsText(f1);
    if (f2) ff3CSV = await readFileAsText(f2);
    if (f3) momTXT = await readFileAsText(f3);

    if (!portfolioCSV || !ff3CSV || !momTXT) {
      alert('Please provide Portfolio CSV, F-F Factors CSV, and Momentum TXT.');
      return;
    }

    const date_needed = (document.getElementById('dateNeeded').value || '').trim() || null;

    const res = await fetch(`${API_BASE}/api/metrics`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ csv: portfolioCSV, ff3_csv: ff3CSV, mom_txt: momTXT, date_needed })
    });
    if (!res.ok) {
      const msg = await res.text();
      throw new Error(msg);
    }
    const payload = await res.json();
    if (!payload.ok) throw new Error(payload.error || 'Server error');

    const d = payload.data;
    // Overview
    document.getElementById('portfolioValue').textContent = '$' + (d.overview.portfolioValue||0).toLocaleString('en-US', {maximumFractionDigits:0});
    document.getElementById('totalAllocation').textContent = ((d.overview.totalAllocationFrac||0)*100).toFixed(1) + '%';
    document.getElementById('activePositions').textContent = d.overview.activePositions || 0;
    document.getElementById('longShortSplit').textContent = `${d.overview.longCount||0} Long / ${d.overview.shortCount||0} Short`;
    document.getElementById('beta').textContent = (d.overview.beta||0).toFixed(2);

    // Positions
    portfolioData = (d.positions||[]);
    updatePositionsTable();

    // Risk
    const r = d.risk || {};
    const pct = x => (x*100).toFixed(2) + '%';
    document.getElementById('portfolioBeta').textContent = (r.portfolioBeta||0).toFixed(2);
    document.getElementById('dailyVol').textContent   = pct(r.dailyVol||0);
    document.getElementById('weeklyVol').textContent  = pct(r.weeklyVol||0);
    document.getElementById('dailyRange').textContent = 'Â±' + pct(r.dailyRange||0);
    document.getElementById('weeklyRange').textContent= 'Â±' + pct(r.weeklyRange||0);
    document.getElementById('maxDD').textContent      = (r.maxDD*100).toFixed(2) + '%';
    document.getElementById('var5').textContent       = (r.var5*100).toFixed(2) + '%';
    document.getElementById('cvar5').textContent      = (r.cvar5*100).toFixed(2) + '%';
    document.getElementById('var1').textContent       = (r.var1*100).toFixed(2) + '%';
    document.getElementById('cvar1').textContent      = (r.cvar1*100).toFixed(2) + '%';
    document.getElementById('tailRisk').textContent   = (r.tailRisk*100).toFixed(2) + '%';
    document.getElementById('tailMultiple').textContent = (r.tailMultiple||0).toFixed(2) + 'x';

    // Factors
    if (d.factors) {
      const map = d.factors;
      const setRow = (key, pref) => {
        if (!map[key]) return;
        document.getElementById(pref+'Beta').textContent = (+map[key].beta).toFixed(3);
        document.getElementById(pref+'Tstat').textContent = (+map[key].t).toFixed(2);
        document.getElementById(pref+'Pval').textContent  = (+map[key].p).toExponential(2);
        document.getElementById(pref+'Sig').textContent   = map[key].sig;
      };
      setRow('Mkt-RF','mkt');
      setRow('SMB','smb');
      setRow('HML','hml');
      setRow('Mom','mom');
    }

    // Charts from exposures
    Object.values(charts).forEach(c => { try{c.destroy()}catch(e){} });
    initializeCharts(d.exposures);

    alert('Calculated via backend successfully.');
    switchTab('overview', document.querySelectorAll('.tab')[0]);
  } catch (e) {
    alert('Error processing CSV: ' + (e?.message || e));
  }
}

function initializeCharts(exposures) {
  const sectors = exposures?.sectors || {};
  const names = exposures?.names || {};

  const sectorCtx = document.getElementById('sectorChart');
  if (sectorCtx) {
    charts.sector = new Chart(sectorCtx.getContext('2d'), {
      type: 'doughnut',
      data: { labels: Object.keys(sectors),
              datasets:[{ data: Object.values(sectors).map(v=>v*100),
                          backgroundColor:['#667eea','#f093fb','#4ade80','#f87171','#fbbf24','#60a5fa','#c084fc','#fb923c','#a78bfa','#34d399'], borderWidth:0 }] },
      options: { responsive:false, plugins:{ legend:{ labels:{ color:'#fff' }, position:'bottom' } } }
    });
  }

  const allocationCtx = document.getElementById('allocationChart');
  const symbols = Object.keys(names);
  const values = symbols.map(s => names[s]*100);
  if (allocationCtx) {
    charts.allocation = new Chart(allocationCtx.getContext('2d'), {
      type: 'bar',
      data: { labels: symbols, datasets:[{ label:'Capital Allocation %', data: values, borderWidth:2 }] },
      options: { responsive:false, plugins:{ legend:{ labels:{ color:'#fff' } } },
        scales:{ x:{ ticks:{ color:'#fff' } }, y:{ ticks:{ color:'#fff', callback:v=>v+'%' } } } }
    });
  }

  const riskCtx = document.getElementById('riskChart');
  if (riskCtx) {
    charts.risk = new Chart(riskCtx.getContext('2d'), {
      type:'line',
      data:{ labels:Array.from({length:100}, (_,i)=> i-50),
        datasets:[{ label:'Return Distribution', data:Array.from({length:100},(_,i)=>{const x=(i-50)/10;return Math.exp(-x*x/2)/Math.sqrt(2*Math.PI)*100}),
                    borderColor:'#667eea', backgroundColor:'rgba(102,126,234,0.1)', fill:true }] },
      options:{ responsive:true, plugins:{ legend:{ labels:{ color:'#fff' } } },
        scales:{ x:{ ticks:{ color:'#fff' } }, y:{ ticks:{ color:'#fff' } } } }
    });
  }
}

function updatePositionsTable() {
  const tbody = document.getElementById('positionsBody'); if (!tbody) return;
  tbody.innerHTML = '';
  portfolioData.forEach(p => {
    const rr = calcRR(p);
    const row = tbody.insertRow();
    row.innerHTML = `
      <td>${p.Symbol}</td>
      <td><span class="status-badge ${p.Execution.toLowerCase()}">${p.Execution}</span></td>
      <td>${p.Sector||''}</td>
      <td>${fmtCap(p.MarketCap)}</td>
      <td>${(p.Price||0).toFixed(2)}</td>
      <td>${fmtVol(p.Volume)}</td>
      <td>${((p.AllocationPercent||0)*100).toFixed(1)}%</td>
      <td>${p.Timeframe||''}</td>
      <td>${(p.Target||0).toFixed(2)}</td>
      <td>${(p.StopLoss||0).toFixed(2)}</td>
      <td class="${rr>=2?'positive':rr>=1?'':'negative'}">1:${rr}</td>`;
  });
}

function calcRR(p){
  const price=p.Price||1, sl=p.StopLoss||price, tgt=p.Target||price;
  const riskPct = Math.abs((price - sl)/price); const rewardPct = Math.abs((tgt - price)/price);
  return (rewardPct/Math.max(riskPct,1e-9)).toFixed(2);
}
function fmtCap(v){ if(v>=1e12)return(v/1e12).toFixed(1)+'T'; if(v>=1e9)return(v/1e9).toFixed(1)+'B'; if(v>=1e6)return(v/1e6).toFixed(1)+'M'; return (v||0).toFixed(0);}
function fmtVol(v){ if(v>=1e6)return(v/1e6).toFixed(1)+'M'; if(v>=1e3)return(v/1e3).toFixed(1)+'K'; return (v||0).toFixed(0);}
</script>
</body>
</html>
