<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Portfolio Risk Analytics Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background:#0a0e27; color:#fff; min-height:100vh;
        }
        .dashboard { padding:20px; max-width:1600px; margin:0 auto; }
        .header {
            background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius:20px; padding:40px; margin-bottom:30px;
            box-shadow:0 20px 40px rgba(0,0,0,0.4); text-align:center;
        }
        h1 { font-size:36px; margin-bottom:10px; text-shadow:2px 2px 4px rgba(0,0,0,0.3); }
        .subtitle { opacity:0.9; font-size:18px; }
        .controls { display:flex; gap:15px; justify-content:center; margin-top:25px; flex-wrap:wrap; }
        .btn {
            background:rgba(255,255,255,0.2); border:2px solid rgba(255,255,255,0.3); color:#fff;
            padding:12px 25px; border-radius:10px; cursor:pointer; font-size:16px; font-weight:600;
            transition:all 0.3s; backdrop-filter:blur(10px);
        }
        .btn:hover { background:rgba(255,255,255,0.3); transform:translateY(-2px); box-shadow:0 5px 15px rgba(255,255,255,0.2); }
        .btn.primary { background:linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border:none; }
        .tabs { display:flex; gap:10px; margin-bottom:30px; background:rgba(255,255,255,0.05); padding:10px; border-radius:15px; flex-wrap:wrap; }
        .tab { padding:12px 25px; background:rgba(255,255,255,0.1); border-radius:10px; cursor:pointer; transition:all 0.3s; font-weight:500; }
        .tab:hover { background:rgba(255,255,255,0.15); }
        .tab.active { background:linear-gradient(135deg, #667eea, #764ba2); color:#fff; box-shadow:0 5px 15px rgba(102,126,234,0.4); }
        .tab-content { display:none; animation:fadeIn 0.5s; }
        .tab-content.active { display:block; }
        @keyframes fadeIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }
        .metrics-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(280px,1fr)); gap:20px; margin-bottom:30px; }
        .metric-card {
            background:linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border:1px solid rgba(255,255,255,0.1); border-radius:15px; padding:25px; backdrop-filter:blur(10px);
            transition:transform 0.3s, box-shadow 0.3s;
        }
        .metric-card:hover { transform:translateY(-5px); box-shadow:0 10px 30px rgba(102,126,234,0.3); }
        .metric-label { font-size:12px; color:rgba(255,255,255,0.7); text-transform:uppercase; letter-spacing:1px; margin-bottom:10px; }
        .metric-value { font-size:32px; font-weight:bold; background:linear-gradient(135deg, #667eea, #f093fb); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
        .metric-change { font-size:14px; margin-top:5px; opacity:0.8; }
        .positive { color:#4ade80; }
        .negative { color:#f87171; }
        .chart-container { background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:15px; padding:25px; margin-bottom:20px; backdrop-filter:blur(10px); }
        .chart-title { font-size:20px; margin-bottom:20px; color:#fff; }
        table { width:100%; background:rgba(255,255,255,0.05); border-radius:15px; overflow:hidden; backdrop-filter:blur(10px); }
        th { background:rgba(102,126,234,0.3); padding:15px; text-align:left; font-weight:600; text-transform:uppercase; font-size:12px; letter-spacing:1px; }
        td { padding:15px; border-bottom:1px solid rgba(255,255,255,0.05); }
        tr:hover { background:rgba(255,255,255,0.05); }
        .upload-area {
            background:rgba(255,255,255,0.05); border:2px dashed rgba(102,126,234,0.5); border-radius:15px; padding:40px;
            text-align:center; margin:20px 0; cursor:pointer; transition:all 0.3s; position:relative;
        }
        .upload-area:hover, .upload-area.dragover { background:rgba(102,126,234,0.1); border-color:#667eea; }
        .upload-area input[type="file"] { position:absolute; width:100%; height:100%; top:0; left:0; opacity:0; cursor:pointer; }
        .status-badge { display:inline-block; padding:4px 12px; border-radius:20px; font-size:12px; font-weight:600; text-transform:uppercase; }
        .buy { background:rgba(74,222,128,0.2); color:#4ade80; }
        .sell { background:rgba(248,113,113,0.2); color:#f87171; }
        textarea {
            width:100%; min-height:200px; background:rgba(255,255,255,0.1);
            border:1px solid rgba(255,255,255,0.2); border-radius:10px; padding:15px; color:#fff; font-family:monospace; font-size:14px; resize:vertical;
        }
        textarea::placeholder { color:rgba(255,255,255,0.5); }
        .grid-2 { display:grid; grid-template-columns:repeat(auto-fit, minmax(500px, 1fr)); gap:20px; }
        .file-info { margin-top:15px; padding:10px; background:rgba(102,126,234,0.2); border-radius:8px; display:none; }
        .file-info.active { display:block; }
        .format-helper { background:rgba(102,126,234,0.1); border:1px solid rgba(102,126,234,0.3); border-radius:10px; padding:15px; margin-top:20px; }
        .format-helper h4 { color:#667eea; margin-bottom:10px; }
        .format-helper code { background:rgba(0,0,0,0.3); padding:2px 6px; border-radius:4px; font-size:12px; }
        .optimizer-section { margin-bottom:30px; }
        .optimizer-controls { background:rgba(255,255,255,0.05); border-radius:10px; padding:20px; margin-bottom:20px; }
        .optimizer-controls h4 { color:#667eea; margin-bottom:15px; }
        .input-group { display:flex; align-items:center; gap:10px; margin-bottom:15px; }
        .input-group label { min-width:150px; font-size:14px; }
        .input-group input, .optimizer-controls select {
            flex:1; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2);
            border-radius:5px; padding:8px; color:#fff; font-size:14px;
        }
        .checkbox-group { display:flex; gap:20px; flex-wrap:wrap; margin:15px 0; }
        .checkbox-group label { display:flex; align-items:center; gap:8px; cursor:pointer; }
        .checkbox-group input[type="checkbox"], .checkbox-group input[type="radio"] { width:18px; height:18px; cursor:pointer; }
        .risk-section { margin-top:30px; }
        .risk-section h3 { color:#f093fb; margin-bottom:20px; }

        /* Keep Overview charts vertically stacked */
        .vertical-stack { display:flex; flex-direction:column; gap:20px; }

        /* Center the two overview charts (title + canvas) */
        .chart-container.centered-chart { display:flex; flex-direction:column; align-items:center; }
        .chart-container.centered-chart canvas { display:block; margin:0 auto; }
    </style>
</head>
<body>
<div class="dashboard">
    <div class="header">
        <h1>Portfolio Risk Analytics Dashboard</h1>
        <p class="subtitle">Advanced Risk Management & Optimization Platform</p>
        <div class="controls">
            <button class="btn primary" onclick="refreshData()">Refresh Data</button>
            <button class="btn" onclick="showUploadDialog()">Upload CSV</button>
            <button class="btn" onclick="runOptimization()">Run Optimization</button>
            <button class="btn" onclick="exportResults()">Export Results</button>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('overview', this)">Overview</div>
        <div class="tab" onclick="switchTab('positions', this)">Positions</div>
        <div class="tab" onclick="switchTab('risk', this)">Risk Metrics</div>
        <div class="tab" onclick="switchTab('factors', this)">Factor Exposure</div>
        <div class="tab" onclick="switchTab('optimization', this)">Optimizer</div>
        <div class="tab" onclick="switchTab('upload', this)">Data Upload</div>
    </div>

    <!-- Overview Tab -->
    <div id="overview" class="tab-content active">
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Portfolio Value</div>
                <div class="metric-value" id="portfolioValue">$0</div>
                <div class="metric-change" id="portfolioChange">Calculating...</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Total Allocation</div>
                <div class="metric-value" id="totalAllocation">0%</div>
                <div class="metric-change">Capital Deployed</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Active Positions</div>
                <div class="metric-value" id="activePositions">0</div>
                <div class="metric-change" id="longShortSplit">Long/Short Split</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Portfolio Beta</div>
                <div class="metric-value" id="beta">0.00</div>
                <div class="metric-change">vs Market</div>
            </div>
        </div>

        <div class="grid-2 vertical-stack">
            <div class="chart-container centered-chart">
                <h3 class="chart-title">Sector Allocation</h3>
                <!-- fixed size + static -->
                <canvas id="sectorChart" width="600" height="240"></canvas>
            </div>
            <div class="chart-container centered-chart">
                <h3 class="chart-title">Capital Allocation by Position</h3>
                <!-- fixed size + static -->
                <canvas id="allocationChart" width="600" height="240"></canvas>
            </div>
        </div>
    </div>

    <!-- Positions Tab -->
    <div id="positions" class="tab-content">
        <div class="chart-container">
            <h3 class="chart-title">Current Positions</h3>
            <table id="positionsTable">
                <thead>
                    <tr>
                        <th>Symbol</th><th>Direction</th><th>Sector</th><th>Market Cap</th>
                        <th>Price</th><th>Volume</th><th>Allocation (%)</th><th>Timeframe</th>
                        <th>Target</th><th>Stop Loss</th><th>Risk/Reward</th>
                    </tr>
                </thead>
                <tbody id="positionsBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Risk Metrics Tab -->
    <div id="risk" class="tab-content">
        <div class="risk-section">
            <h3>Portfolio Risk Analytics</h3>
            <div class="metrics-grid">
                <div class="metric-card"><div class="metric-label">Portfolio Beta</div><div class="metric-value" id="portfolioBeta">-</div><div class="metric-change">Market Exposure</div></div>
                <div class="metric-card"><div class="metric-label">Expected Daily Volatility</div><div class="metric-value" id="dailyVol">-</div><div class="metric-change">1-Day Movement</div></div>
                <div class="metric-card"><div class="metric-label">Weekly Volatility</div><div class="metric-value" id="weeklyVol">-</div><div class="metric-change">5-Day Movement</div></div>
                <div class="metric-card"><div class="metric-label">Expected Daily Range</div><div class="metric-value" id="dailyRange">-</div><div class="metric-change">GK-YZ Estimator</div></div>
                <div class="metric-card"><div class="metric-label">Expected Weekly Range</div><div class="metric-value" id="weeklyRange">-</div><div class="metric-change">GK-YZ Estimator</div></div>
                <div class="metric-card"><div class="metric-label">Max Expected Drawdown</div><div class="metric-value" id="maxDD">-</div><div class="metric-change negative">Peak to Trough</div></div>
            </div>
        </div>

        <div class="risk-section">
            <h3>Value at Risk Analysis</h3>
            <div class="metrics-grid">
                <div class="metric-card"><div class="metric-label">Portfolio 5% VaR</div><div class="metric-value" id="var5">-</div><div class="metric-change negative">5-Day Horizon</div></div>
                <div class="metric-card"><div class="metric-label">Portfolio 5% CVaR</div><div class="metric-value" id="cvar5">-</div><div class="metric-change negative">Conditional VaR</div></div>
                <div class="metric-card"><div class="metric-label">Portfolio 1% VaR</div><div class="metric-value" id="var1">-</div><div class="metric-change negative">Extreme Risk</div></div>
                <div class="metric-card"><div class="metric-label">Portfolio 1% CVaR</div><div class="metric-value" id="cvar1">-</div><div class="metric-change negative">Tail Risk</div></div>
                <div class="metric-card"><div class="metric-label">Tail Risk (0.03%)</div><div class="metric-value" id="tailRisk">-</div><div class="metric-change negative">Black Swan Event</div></div>
                <div class="metric-card"><div class="metric-label">Tail Risk Multiple</div><div class="metric-value" id="tailMultiple">-</div><div class="metric-change">vs Benchmark</div></div>
            </div>
        </div>

        <div class="risk-section">
            <h3>Performance Metrics</h3>
            <div class="metrics-grid">
                <div class="metric-card"><div class="metric-label">Expected Return (Daily)</div><div class="metric-value" id="expReturnDaily">-</div><div class="metric-change positive">Mean Return</div></div>
                <div class="metric-card"><div class="metric-label">Expected Return (Weekly)</div><div class="metric-value" id="expReturnWeekly">-</div><div class="metric-change positive">5-Day Return</div></div>
                <div class="metric-card"><div class="metric-label">Sharpe Ratio (Gross)</div><div class="metric-value" id="sharpeGross">-</div><div class="metric-change">Annualized</div></div>
                <div class="metric-card"><div class="metric-label">Sharpe Ratio (Net)</div><div class="metric-value" id="sharpeNet">-</div><div class="metric-change">After Costs</div></div>
            </div>
        </div>

        <div class="chart-container">
            <h3 class="chart-title">Risk Distribution</h3>
            <canvas id="riskChart"></canvas>
        </div>
    </div>

    <!-- Factor Exposure Tab -->
    <div id="factors" class="tab-content">
        <div class="chart-container">
            <h3 class="chart-title">Carhart Four-Factor Model</h3>
            <table id="factorTable">
                <thead>
                <tr><th>Factor</th><th>Beta</th><th>T-Statistic</th><th>P-Value</th><th>Significance</th></tr>
                </thead>
                <tbody>
                <tr><td>Market (Mkt-RF)</td><td id="mktBeta">-</td><td id="mktTstat">-</td><td id="mktPval">-</td><td id="mktSig">-</td></tr>
                <tr><td>Size (SMB)</td><td id="smbBeta">-</td><td id="smbTstat">-</td><td id="smbPval">-</td><td id="smbSig">-</td></tr>
                <tr><td>Value (HML)</td><td id="hmlBeta">-</td><td id="hmlTstat">-</td><td id="hmlPval">-</td><td id="hmlSig">-</td></tr>
                <tr><td>Momentum (Mom)</td><td id="momBeta">-</td><td id="momTstat">-</td><td id="momPval">-</td><td id="momSig">-</td></tr>
                </tbody>
            </table>
        </div>

        <div class="chart-container" style="margin-top: 20px;">
            <h3 class="chart-title">Factor Exposure Visualization</h3>
            <canvas id="factorChart"></canvas>
        </div>
    </div>

    <!-- Optimization Tab -->
    <div id="optimization" class="tab-content">
        <div class="optimizer-section">
            <div class="optimizer-controls">
                <h4>Factor Neutralization</h4>
                <p style="margin-bottom: 15px; opacity: 0.8;">Select factors to neutralize in portfolio optimization:</p>
                <div class="checkbox-group">
                    <label><input type="checkbox" id="neutralizeMarket" checked><span>Market Beta</span></label>
                    <label><input type="checkbox" id="neutralizeValue"><span>Value Factor</span></label>
                    <label><input type="checkbox" id="neutralizeMomentum"><span>Momentum Factor</span></label>
                    <label><input type="checkbox" id="neutralizeGrowth"><span>Growth Factor</span></label>
                </div>
                <button class="btn primary" onclick="runFactorNeutralization()">Apply Factor Neutralization</button>
            </div>
        </div>

        <div class="optimizer-section">
            <div class="optimizer-controls">
                <h4>Portfolio Optimization</h4>
                <p style="margin-bottom: 15px; opacity: 0.8;">Choose optimization strategy:</p>
                <div class="checkbox-group">
                    <label><input type="radio" name="optStrategy" value="sharpe" checked><span>Maximize Sharpe Ratio</span></label>
                    <label><input type="radio" name="optStrategy" value="minvar"><span>Minimize Variance (GMV)</span></label>
                </div>
                <button class="btn primary" onclick="runPortfolioOptimization()">Optimize Portfolio</button>
            </div>

            <div class="metrics-grid" style="margin-top: 20px;">
                <div class="metric-card"><div class="metric-label">Current Sharpe</div><div class="metric-value" id="currentSharpe">-</div><div class="metric-change">Before Optimization</div></div>
                <div class="metric-card"><div class="metric-label">Optimal Sharpe</div><div class="metric-value" id="optimalSharpe">-</div><div class="metric-change positive">After Optimization</div></div>
                <div class="metric-card"><div class="metric-label">Variance Reduction</div><div class="metric-value" id="varReduction">-</div><div class="metric-change positive">Risk Improvement</div></div>
            </div>
        </div>

        <div class="optimizer-section">
            <div class="optimizer-controls">
                <h4>Tail Risk Hedging</h4>
                <p style="margin-bottom: 15px; opacity: 0.8;">Configure tail risk protection strategy:</p>
                <div class="input-group"><label>Protection Level (%):</label><input type="number" id="protectionLevel" value="10" min="0" max="100" step="1"></div>
                <div class="input-group"><label>Max Hedging Cost (%):</label><input type="number" id="hedgingCost" value="2" min="0" max="10" step="0.1"></div>
                <button class="btn primary" onclick="calculateTailHedge()">Calculate Hedge Requirements</button>
            </div>

            <div class="metrics-grid" style="margin-top: 20px;">
                <div class="metric-card"><div class="metric-label">Unhedged Tail Risk</div><div class="metric-value" id="unhedgedTail">-</div><div class="metric-change negative">Current Exposure</div></div>
                <div class="metric-card"><div class="metric-label">Hedged Tail Risk</div><div class="metric-value" id="hedgedTail">-</div><div class="metric-change positive">After Protection</div></div>
                <div class="metric-card"><div class="metric-label">Hedge Ratio</div><div class="metric-value" id="hedgeRatio">-</div><div class="metric-change">Options Required</div></div>
            </div>
        </div>

        <div class="optimizer-section">
            <div class="optimizer-controls">
                <h4>Volatility Targeting</h4>
                <p style="margin-bottom: 15px; opacity: 0.8;">Set target portfolio volatility:</p>
                <div class="input-group"><label>Target Volatility (%):</label><input type="number" id="targetVol" value="15" min="1" max="50" step="0.5"></div>
                <div class="input-group">
                    <label>Rebalance Frequency:</label>
                    <select id="rebalanceFreq">
                        <option value="daily">Daily</option>
                        <option value="weekly" selected>Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                </div>
                <button class="btn primary" onclick="applyVolatilityTarget()">Apply Volatility Target</button>
            </div>

            <div class="metrics-grid" style="margin-top: 20px;">
                <div class="metric-card"><div class="metric-label">Current Volatility</div><div class="metric-value" id="currentVol">-</div><div class="metric-change">Annualized</div></div>
                <div class="metric-card"><div class="metric-label">Leverage Required</div><div class="metric-value" id="leverageReq">-</div><div class="metric-change">Position Scaling</div></div>
                <div class="metric-card"><div class="metric-label">Expected Tracking</div><div class="metric-value" id="trackingError">-</div><div class="metric-change">vs Target</div></div>
            </div>
        </div>

        <div class="chart-container">
            <h3 class="chart-title">Efficient Frontier</h3>
            <canvas id="frontierChart"></canvas>
        </div>
    </div>

    <!-- Upload Tab -->
    <div id="upload" class="tab-content">
        <div class="chart-container">
            <h3 class="chart-title">Upload Portfolio Data</h3>
            <p style="margin-bottom: 20px; opacity: 0.8;">Upload a CSV file or paste your data below</p>

            <div class="upload-area" id="uploadArea">
                <input type="file" id="fileInput" accept=".csv,text/csv,application/vnd.ms-excel" onchange="handleFileSelect(event)">
                <div>
                    <svg style="width: 48px; height: 48px; margin-bottom: 15px; opacity: 0.6;" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    <p style="font-size: 18px; margin-bottom: 10px;">Drop CSV file here or click to browse</p>
                    <p style="font-size: 14px; opacity: 0.7;">Supported format: .csv</p>
                </div>
            </div>

            <div class="file-info" id="fileInfo">
                <p><strong>File loaded:</strong> <span id="fileName"></span></p>
                <p><strong>Size:</strong> <span id="fileSize"></span></p>
                <p><strong>Rows:</strong> <span id="fileRows"></span></p>
            </div>

            <p style="margin: 20px 0; text-align: center; opacity: 0.7;">— OR —</p>

            <textarea id="csvInput" placeholder="Symbol,Execution,Sector,Market Capitalisation,Price,Volume,Capital Allocation,Timeframe,Target,Stop Loss
AAPL,Buy,Technology,3000000000000,195.23,45000000,1550,Swing,210.00,185.00
MSFT,Buy,Technology,2800000000000,412.56,25000000,1230,Position,425.00,400.00
JPM,Sell,Financial,450000000000,156.78,12000000,870,Day,150.00,160.00"></textarea>

            <div style="margin-top: 20px;">
                <button class="btn primary" onclick="processCSV()">Process CSV Data</button>
                <button class="btn" onclick="clearData()">Clear All Data</button>
                <button class="btn" onclick="downloadSampleCSV()">Download Sample CSV</button>
            </div>

            <div class="format-helper">
                <h4>Required CSV Format:</h4>
                <p style="font-size: 14px; line-height: 1.6;">
                    Columns:<br>
                    <code>Symbol</code>, <code>Execution</code>, <code>Sector</code>, <code>Market Capitalisation</code>, <code>Price</code>, <code>Volume</code>, <code>Capital Allocation</code>, <code>Timeframe</code>, <code>Target</code>, <code>Stop Loss</code>
                </p>
            </div>
        </div>
    </div>
</div>

<script>
let portfolioData = [];
let charts = {};
const API_BASE = 'http://localhost:8000'; // your adapter base

// ---- Actions ----
function refreshData() {
    updateDashboard();
    updatePositionsTable();
    updateRiskMetricsPlaceholders();
    alert('Dashboard refreshed');
}
function showUploadDialog() {
    switchTab('upload', document.querySelectorAll('.tab')[5]);
}
function runOptimization() { runPortfolioOptimization(); }
function exportResults() {
    if (portfolioData.length === 0) { alert('No data to export. Please upload data first.'); return; }
    const csvContent = 'Symbol,Execution,Sector,Market Capitalisation,Price,Volume,Capital Allocation,Timeframe,Target,Stop Loss\n' +
        portfolioData.map(p =>
            `${p.Symbol},${p.Execution},${p.Sector},${p.MarketCap},${p.Price},${p.Volume},${p.Allocation},${p.Timeframe},${p.Target},${p.StopLoss}`
        ).join('\n');
    const blob = new Blob([csvContent], { type:'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'portfolio_export.csv'; a.click();
}

// ---- Tabs ----
function switchTab(tabName, element) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    element.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');
}

// ---- File handling ----
function handleFileSelect(e) {
    const file = e.target.files[0];
    if (file) { handleFile(file); }
}
function handleFile(file) {
    const isCSV = (file.type && file.type.toLowerCase().includes('csv')) || file.name.toLowerCase().endsWith('.csv');
    if (!isCSV) { alert('Please upload a CSV (.csv) file'); return; }

    const reader = new FileReader();
    reader.onload = function(ev) {
        const content = ev.target.result;
        document.getElementById('csvInput').value = content;

        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileSize').textContent = (file.size / 1024).toFixed(2) + ' KB';
        document.getElementById('fileRows').textContent = content.split(/\r?\n/).length - 1;
        document.getElementById('fileInfo').classList.add('active');

        processCSV();
    };
    reader.readAsText(file);
}

// ---- CSV -> Backend ----
async function processCSV() {
    const ta = document.getElementById('csvInput');
    const csvText = (ta.value && ta.value.trim()) ? ta.value.trim() : (ta.getAttribute('placeholder') || '').trim();
    if (!csvText) { alert('Please paste CSV data or upload a file first'); return; }

    try {
        const res = await fetch(`${API_BASE}/api/metrics`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ csv: csvText })
        });
        const payload = await res.json();
        if (!payload.ok) throw new Error(payload.error || 'Server error');

        const d = payload.data;

        // positions for table
        portfolioData = (d.positions || []).map(p => ({
            Symbol: p.Symbol,
            Execution: p.Execution,
            Sector: p.Sector,
            MarketCap: p.MarketCap || 0,
            Price: p.Price || 0,
            Volume: p.Volume || 0,
            Allocation: p.Allocation || 0,
            AllocationPercent: p.AllocationPercent || 0,
            Timeframe: p.Timeframe || '',
            Target: p.Target || 0,
            StopLoss: p.StopLoss || 0,
        }));

        // Overview from backend
        document.getElementById('portfolioValue').textContent =
            '$' + (d.overview.portfolioValue || 0).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        document.getElementById('totalAllocation').textContent =
            ((d.overview.totalAllocationFrac || 0) * 100).toFixed(1) + '%';
        document.getElementById('activePositions').textContent = d.overview.activePositions || 0;
        document.getElementById('portfolioChange').textContent =
            `${d.overview.longCount || 0} Long / ${d.overview.shortCount || 0} Short`;
        document.getElementById('beta').textContent = (d.overview.beta || 0).toFixed(2);

        // Risk metrics
        const r = d.risk || {};
        const pct = (x) => (x*100).toFixed(1) + '%';
        document.getElementById('portfolioBeta').textContent = (r.portfolioBeta || 0).toFixed(2);
        document.getElementById('dailyVol').textContent   = pct(r.dailyVol || 0);
        document.getElementById('weeklyVol').textContent  = pct(r.weeklyVol || 0);
        document.getElementById('dailyRange').textContent = '±' + pct(r.dailyRange || 0);
        document.getElementById('weeklyRange').textContent= '±' + pct(r.weeklyRange || 0);
        document.getElementById('maxDD').textContent      = (r.maxDD ? (r.maxDD*100).toFixed(1) : '-4.5') + '%';

        document.getElementById('var5').textContent  = (r.var5  ? (r.var5*100).toFixed(1)  : -2.8) + '%';
        document.getElementById('cvar5').textContent = (r.cvar5 ? (r.cvar5*100).toFixed(1) : -3.5) + '%';
        document.getElementById('var1').textContent  = (r.var1  ? (r.var1*100).toFixed(1)  : -4.2) + '%';
        document.getElementById('cvar1').textContent = (r.cvar1 ? (r.cvar1*100).toFixed(1) : -5.1) + '%';
        document.getElementById('tailRisk').textContent = (r.tailRisk ? (r.tailRisk*100).toFixed(1) : -8.5) + '%';
        document.getElementById('tailMultiple').textContent = (r.tailMultiple || 0).toFixed(2) + 'x';

        document.getElementById('expReturnDaily').textContent  = ((r.expReturnDaily||0)*100).toFixed(2) + '%';
        document.getElementById('expReturnWeekly').textContent = ((r.expReturnWeekly||0)*100).toFixed(2) + '%';
        document.getElementById('sharpeGross').textContent     = (r.sharpeGross || 0).toFixed(2);
        document.getElementById('sharpeNet').textContent       = (r.sharpeNet   || 0).toFixed(2);

        // Factor table (optional if adapter provides)
        if (d.factors) {
            const map = d.factors;
            if (map['Mkt-RF']) {
                document.getElementById('mktBeta').textContent = (+map['Mkt-RF'].beta).toFixed(3);
                document.getElementById('mktTstat').textContent = map['Mkt-RF'].t ?? '-';
                document.getElementById('mktPval').textContent  = map['Mkt-RF'].p ?? '-';
                document.getElementById('mktSig').textContent   = map['Mkt-RF'].sig ?? '—';
            }
            if (map['SMB']) {
                document.getElementById('smbBeta').textContent = (+map['SMB'].beta).toFixed(3);
                document.getElementById('smbTstat').textContent = map['SMB'].t ?? '-';
                document.getElementById('smbPval').textContent  = map['SMB'].p ?? '-';
                document.getElementById('smbSig').textContent   = map['SMB'].sig ?? '—';
            }
            if (map['HML']) {
                document.getElementById('hmlBeta').textContent = (+map['HML'].beta).toFixed(3);
                document.getElementById('hmlTstat').textContent = map['HML'].t ?? '-';
                document.getElementById('hmlPval').textContent  = map['HML'].p ?? '-';
                document.getElementById('hmlSig').textContent   = map['HML'].sig ?? '—';
            }
            if (map['Mom']) {
                document.getElementById('momBeta').textContent = (+map['Mom'].beta).toFixed(3);
                document.getElementById('momTstat').textContent = map['Mom'].t ?? '-';
                document.getElementById('momPval').textContent  = map['Mom'].p ?? '-';
                document.getElementById('momSig').textContent   = map['Mom'].sig ?? '—';
            }
        }

        // Charts from backend exposures
        Object.values(charts).forEach(c => { try { c.destroy(); } catch(e){} });
        initializeChartsFromBackend(d.exposures);

        updatePositionsTable();
        switchTab('overview', document.querySelector('.tab'));
    } catch (err) {
        alert('Error processing CSV: ' + err.message);
    }
}

// ---- Chart init from backend exposures ----
function initializeChartsFromBackend(exposures) {
    const sectors = exposures?.sectors || {};
    const names = exposures?.names || {};

    // Sector doughnut (fixed size, centered)
    const sectorCtx = document.getElementById('sectorChart');
    if (sectorCtx) {
        charts.sector = new Chart(sectorCtx.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(sectors),
                datasets: [{
                    data: Object.values(sectors).map(v=>v*100),
                    backgroundColor:['#667eea','#f093fb','#4ade80','#f87171','#fbbf24','#60a5fa','#c084fc','#fb923c','#a78bfa','#34d399'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: false,           // static size
                maintainAspectRatio: false,
                plugins: {
                    legend: { labels:{ color:'#fff' }, position:'bottom' },
                    tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${ctx.parsed.toFixed(2)}%` } }
                }
            }
        });
    }

    // Name-wise (allocation) bar (fixed size, centered)
    const allocationCtx = document.getElementById('allocationChart');
    if (allocationCtx) {
        const symbols = Object.keys(names);
        const values  = symbols.map(s => names[s]*100);
        const dirBySymbol = {};
        portfolioData.forEach(p => { dirBySymbol[p.Symbol] = p.Execution; });

        charts.allocation = new Chart(allocationCtx.getContext('2d'), {
            type:'bar',
            data:{
                labels: symbols,
                datasets:[{
                    label:'Capital Allocation %',
                    data: values,
                    backgroundColor: symbols.map(sym => (dirBySymbol[sym]==='Sell'?'rgba(248,113,113,0.6)':'rgba(74,222,128,0.6)')),
                    borderColor: symbols.map(sym => (dirBySymbol[sym]==='Sell'?'#f87171':'#4ade80')),
                    borderWidth:2
                }]
            },
            options:{
                responsive:false,           // static size
                maintainAspectRatio:false,
                plugins:{ legend:{ display:true, labels:{ color:'#fff' } } },
                scales:{
                    x:{ grid:{ color:'rgba(255,255,255,0.1)' }, ticks:{ color:'#fff' } },
                    y:{ grid:{ color:'rgba(255,255,255,0.1)' }, ticks:{ color:'#fff', callback:(v)=> v + '%' } }
                }
            }
        });
    }

    // Risk Distribution (aesthetic sample curve)
    const riskCtx = document.getElementById('riskChart');
    if (riskCtx) {
        charts.risk = new Chart(riskCtx.getContext('2d'), {
            type:'line',
            data:{ labels:Array.from({length:100}, (_,i)=> i-50),
                datasets:[{ label:'Return Distribution',
                    data:Array.from({length:100}, (_,i)=> { const x=(i-50)/10; return Math.exp(-x*x/2)/Math.sqrt(2*Math.PI)*100; }),
                    borderColor:'#667eea', backgroundColor:'rgba(102,126,234,0.1)', fill:true
                }]
            },
            options:{ responsive:true, plugins:{ legend:{ labels:{ color:'#fff' } } },
                scales:{ x:{ title:{ display:true, text:'Returns (%)', color:'#fff' }, grid:{ color:'rgba(255,255,255,0.1)' }, ticks:{ color:'#fff' } },
                         y:{ title:{ display:true, text:'Probability', color:'#fff' }, grid:{ color:'rgba(255,255,255,0.1)' }, ticks:{ color:'#fff' } } }
            }
        });
    }

    // Factor radar can remain as-is or be fed with backend later
}

// ---- Placeholders (used only before backend fills) ----
function updateRiskMetricsPlaceholders() {
    if (portfolioData.length === 0) return;
}

// ---- Overview fallback calc (uses $100mm × percentage) ----
function updateDashboard() {
    if (portfolioData.length === 0) {
        document.getElementById('portfolioValue').textContent = '$0';
        document.getElementById('totalAllocation').textContent = '0%';
        document.getElementById('activePositions').textContent = '0';
        document.getElementById('beta').textContent = '0.00';
        return;
    }
    let totalValue = 0, totalAllocation = 0, buyCount = 0, sellCount = 0, totalBeta = 0;

    portfolioData.forEach(p => {
        totalValue += 100000000 * (p.AllocationPercent || 0);
        totalAllocation += (p.AllocationPercent || 0);
        if (p.Execution === 'Buy') buyCount++; else sellCount++;
        const direction = p.Execution === 'Buy' ? 1 : -1;
        const simulatedBeta = 1.0; // placeholder; backend overwrites real beta
        totalBeta += simulatedBeta * direction * (p.AllocationPercent || 0);
    });

    document.getElementById('portfolioValue').textContent =
        '$' + totalValue.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    document.getElementById('totalAllocation').textContent = (totalAllocation * 100).toFixed(1) + '%';
    document.getElementById('activePositions').textContent = portfolioData.length;
    document.getElementById('portfolioChange').textContent = `${buyCount} Long / ${sellCount} Short`;
    document.getElementById('beta').textContent = totalBeta.toFixed(2);
}

// ---- Positions table ----
function formatMarketCap(v) {
    if (v >= 1e12) return (v/1e12).toFixed(1) + 'T';
    if (v >= 1e9)  return (v/1e9).toFixed(1) + 'B';
    if (v >= 1e6)  return (v/1e6).toFixed(1) + 'M';
    return (v||0).toFixed(0);
}
function formatVolume(v) {
    if (v >= 1e6) return (v/1e6).toFixed(1) + 'M';
    if (v >= 1e3) return (v/1e3).toFixed(1) + 'K';
    return (v||0).toFixed(0);
}
function calculateRiskReward(p) {
    const riskPct = Math.abs((p.Price - p.StopLoss) / (p.Price || 1) * 100);
    const rewardPct = Math.abs((p.Target - p.Price) / (p.Price || 1) * 100);
    return (rewardPct / (riskPct || 1)).toFixed(2);
}
function updatePositionsTable() {
    const tbody = document.getElementById('positionsBody');
    if (!tbody) return;
    tbody.innerHTML = '';
    portfolioData.forEach(p => {
        const row = tbody.insertRow();
        const rr = calculateRiskReward(p);
        row.innerHTML = `
            <td>${p.Symbol}</td>
            <td><span class="status-badge ${p.Execution.toLowerCase()}">${p.Execution}</span></td>
            <td>${p.Sector}</td>
            <td>${formatMarketCap(p.MarketCap)}</td>
            <td>${(p.Price||0).toFixed(2)}</td>
            <td>${formatVolume(p.Volume)}</td>
            <td>${((p.AllocationPercent||0) * 100).toFixed(1)}%</td>
            <td>${p.Timeframe||''}</td>
            <td>${(p.Target||0).toFixed(2)}</td>
            <td>${(p.StopLoss||0).toFixed(2)}</td>
            <td class="${rr >= 2 ? 'positive' : rr >= 1 ? '' : 'negative'}">1:${rr}</td>
        `;
    });
}

// ---- Optimizer (calls adapter; core Python logic unchanged) ----
async function runPortfolioOptimization() {
    const strategy = document.querySelector('input[name="optStrategy"]:checked').value; // 'sharpe' or 'minvar'
    const strategyKey = (strategy === 'minvar') ? 'gmv' : 'sharpe';
    const csvText = (document.getElementById('csvInput').value || document.getElementById('csvInput').getAttribute('placeholder') || '').trim();
    if (!csvText) { alert('Please upload or paste a CSV first.'); return; }

    try {
        const res = await fetch(`${API_BASE}/api/optimize`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ strategy: strategyKey, csv: csvText })
        });
        const payload = await res.json();
        if (!payload.ok) throw new Error(payload.error || 'Optimizer error');

        const out = payload.data;
        document.getElementById('currentSharpe').textContent = (out.currentSharpe || 0).toFixed(2);
        document.getElementById('optimalSharpe').textContent = (out.optimalSharpe || 0).toFixed(2);
        document.getElementById('varReduction').textContent = (out.varianceReductionPct || 0).toFixed(1) + '%';

        const frontierCtx = document.getElementById('frontierChart');
        if (frontierCtx) {
            if (charts.frontier && charts.frontier.destroy) charts.frontier.destroy();
            charts.frontier = new Chart(frontierCtx.getContext('2d'), {
                type: 'scatter',
                data: {
                    datasets: [
                        { label:'Efficient Frontier',
                          data: (out.frontier || []).map(p => ({x:p.x, y:p.y})),
                          borderColor:'#667eea', backgroundColor:'rgba(102,126,234,0.5)', showLine:true, fill:false },
                        { label:'Current Portfolio',
                          data:[ out.currentPoint || {x:0,y:0} ],
                          backgroundColor:'#f093fb', pointRadius:10 },
                        { label:'Optimal Portfolio',
                          data:[ out.optimalPoint || {x:0,y:0} ],
                          backgroundColor:'#4ade80', pointRadius:10 }
                    ]
                },
                options:{
                    responsive:true,
                    plugins:{ legend:{ labels:{ color:'#fff' } } },
                    scales:{
                        x:{ title:{ display:true, text:'Risk (%)', color:'#fff' }, grid:{ color:'rgba(255,255,255,0.1)' }, ticks:{ color:'#fff' } },
                        y:{ title:{ display:true, text:'Return (%)', color:'#fff' }, grid:{ color:'rgba(255,255,255,0.1)' }, ticks:{ color:'#fff' } }
                    }
                }
            });
        }

        alert(`Optimization complete: ${strategyKey.toUpperCase()}`);
    } catch (e) {
        alert('Optimization failed: ' + e.message);
    }
}

// ---- Other controls ----
function runFactorNeutralization() {
    const factors = [];
    if (document.getElementById('neutralizeMarket').checked) factors.push('Market');
    if (document.getElementById('neutralizeValue').checked) factors.push('Value');
    if (document.getElementById('neutralizeMomentum').checked) factors.push('Momentum');
    if (document.getElementById('neutralizeGrowth').checked) factors.push('Growth');
    alert(`Applying factor neutralization for: ${factors.join(', ')}\n(Recalculate weights in backend adapter if needed)`);
}
function calculateTailHedge() {
    const protectionLevel = document.getElementById('protectionLevel').value;
    const hedgingCost = document.getElementById('hedgingCost').value;
    document.getElementById('unhedgedTail').textContent = '-8.5%';
    document.getElementById('hedgedTail').textContent = '-' + (8.5 * (1 - protectionLevel/100)).toFixed(1) + '%';
    document.getElementById('hedgeRatio').textContent = (protectionLevel / 10).toFixed(1) + 'x';
    alert(`Calculating tail risk hedge:\nProtection Level: ${protectionLevel}%\nMax Cost: ${hedgingCost}%`);
}
function applyVolatilityTarget() {
    const targetVol = document.getElementById('targetVol').value;
    const rebalanceFreq = document.getElementById('rebalanceFreq').value;
    const currentVol = 18.5;
    const leverage = targetVol / currentVol;
    document.getElementById('currentVol').textContent = currentVol.toFixed(1) + '%';
    document.getElementById('leverageReq').textContent = leverage.toFixed(2) + 'x';
    document.getElementById('trackingError').textContent = '0.8%';
    alert(`Applying volatility target:\nTarget: ${targetVol}%\nRebalance: ${rebalanceFreq}\nLeverage Required: ${leverage.toFixed(2)}x`);
}

// Utilities for Upload tab
function downloadSampleCSV() {
    const sampleCSV = `Symbol,Execution,Sector,Market Capitalisation,Price,Volume,Capital Allocation,Timeframe,Target,Stop Loss
AAPL,Buy,Technology,3000000000000,195.23,45000000,1550,Swing,210.00,185.00
MSFT,Buy,Technology,2800000000000,412.56,25000000,1230,Position,425.00,400.00
JPM,Sell,Financial,450000000000,156.78,12000000,870,Day,150.00,160.00`;
    const blob = new Blob([sampleCSV], { type:'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'sample_portfolio.csv'; a.click();
}
function clearData() {
    document.getElementById('csvInput').value = '';
    document.getElementById('fileInfo').classList.remove('active');
    document.getElementById('fileInput').value = '';
    portfolioData = [];
    Object.values(charts).forEach(c => { try { c.destroy(); } catch(e){} });
    initializeChartsFromBackend({sectors:{},names:{}}); // blank
    updateDashboard();
    updatePositionsTable();
}

// ---- Drag & Drop ----
function setupDragAndDrop() {
    const uploadArea = document.getElementById('uploadArea');
    if (!uploadArea) return;
    ['dragenter','dragover','dragleave','drop'].forEach(evt => uploadArea.addEventListener(evt, preventDefaults, false));
    function preventDefaults(e){ e.preventDefault(); e.stopPropagation(); }
    ['dragenter','dragover'].forEach(evt => uploadArea.addEventListener(evt, () => uploadArea.classList.add('dragover'), false));
    ['dragleave','drop'].forEach(evt => uploadArea.addEventListener(evt, () => uploadArea.classList.remove('dragover'), false));
    uploadArea.addEventListener('drop', handleDrop, false);
}
function handleDrop(e) {
    const dt = e.dataTransfer; const files = dt.files;
    if (files.length > 0) handleFile(files[0]);
}

// ---- Init ----
document.addEventListener('DOMContentLoaded', function() {
    updateDashboard(); // zero-state
    initializeChartsFromBackend({sectors:{},names:{}}); // empty charts, fixed size
    updatePositionsTable();
    setupDragAndDrop();
});
</script>
</body>
</html>
